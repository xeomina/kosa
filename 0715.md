# 0715

## 쿠버네티스

* docker 설치

```
# curl https://download.docker.com/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo
# sed -i -e "s/enabled=1/enabled=0/g" /etc/yum.repos.d/docker-ce.repo
# yum --enablerepo=docker-ce-stable -y install docker-ce-19.03.15-3.el7
```

![image-20220715101034284](md-images/0715/image-20220715101034284.png)

```
# mkdir /etc/docker
# cat <<EOF | sudo tee /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF
```

![image-20220715101907063](md-images/0715/image-20220715101907063.png)

```
# systemctl enable --now docker
# systemctl daemon-reload
# systemctl restart docker
# systemctl status firewalld
# sestatus
```

```
# systemctl disable --now firewalld
# setenforce 0
# sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config
```

![image-20220715101933387](md-images/0715/image-20220715101933387.png)

```
# swapoff -a
# free -h
```

![image-20220715102103206](md-images/0715/image-20220715102103206.png)

* 맨 밑줄 주석처리

```
# sed -i '/ swap / s/^/#/' /etc/fstab
```

![image-20220715102119039](md-images/0715/image-20220715102119039.png)

```
cat <<EOF > /etc/sysctl.d/k8s.conf			# kubernetes
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
```

![image-20220715102317421](md-images/0715/image-20220715102317421.png)

```
# cat <<'EOF' > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
```

![image-20220715102559909](md-images/0715/image-20220715102559909.png)

* 쿠버네티스 설치

```
# yum -y install kubeadm-1.19.16-0 kubelet-1.19.16-0 kubectl-1.19.16-0 --disableexcludes=kubernetes
# systemctl enable kubelet
# poweroff
```



### 이후 VM 복제

![image-20220715104918117](md-images/0715/image-20220715104918117.png)



### All Node

```
# cat <<EOF >> /etc/hosts
192.168.1.192 master1
192.168.1.222 worker1
192.168.1.224 worker2
EOF
```

![image-20220715104334208](md-images/0715/image-20220715104334208.png)

```
# hostnamectl set-hostname <VM NAME>
```

![image-20220715104457895](md-images/0715/image-20220715104457895.png)



### Master

```
# kubeadm init --apiserver-advertise-address=192.168.1.192 --pod-network-cidr=10.244.0.0/16
```

![image-20220715105117621](md-images/0715/image-20220715105117621.png)

* 사용자 등록 및 yaml 파일 적용

```
# mkdir -p $HOME/.kube
# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
# chown $(id -u):$(id -g) $HOME/.kube/config
# kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
```

![image-20220715110511473](md-images/0715/image-20220715110511473.png)

### Node 

* 아까 설치한 후 뜬 토큰 정보 worker 1,2에 복사 붙여넣기

```
kubeadm join 192.168.1.192:6443 --token 141epo.gwp6nnxa59auxbzr \
    --discovery-token-ca-cert-hash sha256:8495bc09969697deac93a0a52edefe15fececeaa8b3c0261c147e010da284202
```

![image-20220715110705212](md-images/0715/image-20220715110705212.png)

![image-20220715110838492](md-images/0715/image-20220715110838492.png)

```
# kubectl get node
```

![image-20220715110907778](md-images/0715/image-20220715110907778.png)











```
# kubectl get pods --all-namespaces
# source <(kubectl completion bash)
# echo "source <(kubectl completion bash)" >> ~/.bashrc
# exit
```

