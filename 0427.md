# 0427

## 구성도 수정

![kosa-NAT GateWay PRO.drawio (1)](./md-images/0427/kosa-NAT%20GateWay%20PRO.drawio%20(1).png)



## 실습 전 환경설정

### 네트워크 설정

![image-20220427092654707](./md-images/0427/image-20220427092654707.png)

* VMnet0 :  진짜 랜카드(이더넷)의 드라이브
  * 현재 사용하고 있는 Realtek(물리) 랜카드 선택



### Mobaxterm 경로 설정

![image-20220427094502853](./md-images/0427/image-20220427094502853.png)

![image-20220427094631136](md-images/0427/image-20220427094631136.png)



![image-20220427094649360](C:/Users/r2com/AppData/Roaming/Typora/typora-user-images/image-20220427094649360.png)



### Key 설정

![image-20220427094958708](md-images/0427/image-20220427094958708.png)

![image-20220427095325619](md-images/0427/image-20220427095325619.png)

![image-20220427100653036](md-images/0427/image-20220427100653036.png)



### IP 대역

- 공인IP = Public IP
- 사설IP = Private IP
  - A Class	10.0.0.0 ~ 10.255.255.255
  - B Class	172.16.0.0 ~ 172.31.255.255
  - C Class	192.168.0.0 ~ 192.168.255.255
- 강의실 네트워크
  - Public Subnet
    - 192.168.0.0/24
    - 192.168.0.0 ~ 192.168.0.255 (256개 IP - 2개 = 254개)
    - 192.168.0.0				네트워크 주소(시작 IP)
    - 192.168.0.255			브로드캐스팅 주소(마지막 IP)
  - Private Subnet
    - 10.0.23.0/24
    - 10.0.23.0 ~ 10.0.23.255 (256개 IP - 2개 = 254개)
    - 10.0.23.0				네트워크 주소(시작 IP)
    - 10.0.23.255			브로드캐스팅 주소(마지막 IP)



## 실습

### NAT

* hostname  변경

```
# hostnamectl set-hostname nat
```



* 라우터 설정
  * ens33은 ip를 수동으로 만들어줘야 한다. (New File)

```
# vi /etc/sysconfig/network-scripts/ifcfg-ens32
TYPE=Ethernet
BOOTPROTO=none
NAME=ens32
DEVICE=ens32
ONBOOT=yes
IPADDR=192.168.0.218
NETMASK=255.255.255.0
GATEWAY=192.168.0.1
DNS1=8.8.8.8
DNS2=203.248.252.2
```

```
# vi /etc/sysconfig/network-scripts/ifcfg-ens33
TYPE=Ethernet
BOOTPROTO=none
NAME=ens33
DEVICE=ens33
ONBOOT=yes
IPADDR=10.0.23.1		/* 내부 라우터 ip
NETMASK=255.255.255.0	/* ip 고정하기위해 마스크
```



* 네트워크 재시작

```
# systemctl restart network
```



* IP 확인

![image-20220427103708086](md-images/0427/image-20220427103708086.png)



* tab 자동완성 (bash-completion)

```
# yum install -y bash-completion
```



* 랜카드 존 설정

```
# firewall-cmd --get-active-zone
public
  interfaces: ens32 ens33
  
# nmcli c mod ens32 connection.zone external
# nmcli c mod ens33 connection.zone internal

# firewall-cmd --get-active-zone
internal
  interfaces: ens33
external
  interfaces: ens32
```



* ip forward 활성화
  * 앞서 nmcli가 이미 설정해줌

```
# sysctl -w net.ipv4.ip_forward=1		  # 리눅스 시스템을 라우터로
# sysctl -p								# 설정 저장
# reboot
# cat /proc/sys/net/ipv4/ip_forward
1
```



* dhcp 데몬설치

```
# yum install dhcp -y
```



* dhcpd.conf 파일 설정

```
# vi /etc/dhcp/dhcpd.conf
ddns-update-style interim;	
subnet 10.0.23.0 netmask 255.255.255.0 {				# 본인의 ip 대역 - 네트워크 지칭
option routers 10.0.23.1;
option subnet-mask 255.255.255.0;
range dynamic-bootp 10.0.23.2 10.0.23.254;				# 이론적으로는 0~255 가능, but 0: 네트워크 주소/255: 브로드캐스팅 주소/1: 라우터
option domain-name-servers 10.0.23.1, 8.8.8.8, 203.248.252.2;	 # 10.0.23.1 : ns의 IP
default-lease-time 7200;	#7200s=2h
max-lease-time 86400;		#86400s=24h
}
```



Cf) 만약 DNS 대란이 날 경우..?

* 다른 ISP의 DNS 서버를 보조 DNS로 추가

  * 구글의 DNS : 8.8.8.8 / 8.8.4.4
  * LG U+의 DNS : 203.248.252.2 (현재 강의장)

  

![image-20220427111430775](md-images/0427/image-20220427111430775.png)

![image-20220427111734416](md-images/0427/image-20220427111734416.png)



* enable 설정

```
# systemctl enable --now dhcpd
```



### DNS

* DNS 도구 설치(bind)

```
# yum -y install bind bind-chroot bind-utils
```



* named.conf 파일 설정
  * named 데몬의 설정파일

```
# vi /etc/named.conf
options {
        listen-on port 53 { 127.0.0.1; 192.168.0/24; 10.0.23/24; };		#NS에 접근할 IP범위(접근제어)
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        recursing-file  "/var/named/data/named.recursing";
        secroots-file   "/var/named/data/named.secroots";
        allow-query     { localhost; 192.168.0/24; 10.0.23/24; };		#쿼리할 IP범위
        forwarders { 8.8.8.8; 203.248.252.2; };

        recursion yes;

        dnssec-enable yes;
        dnssec-validation yes;

        # Path to ISC DLV key */
        bindkeys-file "/etc/named.iscdlv.key";

        managed-keys-directory "/var/named/dynamic";

        pid-file "/run/named/named.pid";
        session-keyfile "/run/named/session.key";
};

logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
        };
};
view "internal" {
        zone "." IN {
                type hint;
                file "named.ca";
        };

        include "/etc/named.rfc1912.zones";
        include "/var/named/xeomina.shop.zones"; # 호스팅 영역 생성
};
```



- xeomina.shop.zones 파일 설정
  - DNS db 파일을 등록하는 설정 파일 - db 파일명과 경로 설정 및 동기화
    - db 파일 안에 도메인과 IP정의

```
# vi /var/named/xeomina.shop.zones
zone "xeomina.shop" IN {			#도메인을 IP로(정방향)
        type master;
        file "xeomina.shop.db";
        allow-update { none; };
};

zone "23.0.10.in-addr.arpa" IN {	#IP를 도메인으로(역방향)
        type master;
        file "23.0.10.in-addr.arpa.db";
        allow-update { none; };
};
```



* xeomina.shop.db 파일 설정

```
# vi /var/named/xeomina.shop.db
$TTL    86400
@       IN      SOA     xeomina.shop.   root.xeomina.shop.(
                        2022041401 ; Serial
                        3h         ; Refresh
                        1h         ; Retry
                        1w         ; Expire
                        1h )       ; Minimum

        IN      NS      ns.xeomina.shop.
        IN      MX 10   ns.xeomina.shop.
ns      IN      A       10.0.23.1
```



* 23.0.10.in-addr.arpa.db 파일 설정

```
# vi /var/named/23.0.10.in-addr.arpa.db
$TTL    86400
@       IN      SOA     xeomina.shop.   root.xeomina.shop.(
                        2022042701 ; Serial
                        3h         ; Refresh
                        1h         ; Retry
                        1w         ; Expire
                        1h )       ; Minimum

        IN      NS      ns.xeomina.shop.
1       IN      PTR     ns.xeomina.shop.
```



* 방화벽 설정
  * 내부에서 DNS로 접근할 수 있도록

```
# firewall-cmd --permanent --add-service=dns --zone=internal
# firewall-cmd --reload

# firewall-cmd --list-all --zone=internal
internal (active)
  interfaces: ens33
  services: dhcpv6-client dns mdns samba-client ssh
```



### IP 정리

| 이름              | OS       | IP        |
| ----------------- | -------- | --------- |
| NAT_GW_DHCP_HA_NS | CentOS7  | 10.0.23.1 |
| WEB01             | CentOS7  | 10.0.23.2 |
| DB_SMB_NFS        | CentOS7  | 10.0.23.3 |
| WEB02             | Ubuntu18 | 10.0.23.4 |
| WEB03             | Win2012  | 10.0.23.5 |



* xeomina.shop.db 파일 설정 변경

```
# vi /var/named/xeomina.shop.db
$TTL    86400
@       IN      SOA     xeomina.shop.   root.xeomina.shop.(
                        2022041401 ; Serial
                        3h         ; Refresh
                        1h         ; Retry
                        1w         ; Expire
                        1h )       ; Minimum

        IN      NS      ns.xeomina.shop.
        IN      MX 10   ns.xeomina.shop.
nat     IN      A       192.168.0.218
ns      IN      A       10.0.23.1
web01   IN      A       10.0.23.2
db      IN      A       10.0.23.3
web02   IN      A       10.0.23.4
web03   IN      A       10.0.23.5
```



* named 재시작

```
# systemctl restart named
```



* 방화벽 설정
  * 외부에서도 dns 접근가능하게
  * nat 서버에 도메인으로 접속 시도

```
# firewall-cmd --permanent --add-service=dns --zone=external
# firewall-cmd --reload
```



* 로컬 dns 서버 변경

![image-20220427123201057](md-images/0427/image-20220427123201057.png)

* ip 확인

![image-20220427123316668](md-images/0427/image-20220427123316668.png)

* ping 확인

![image-20220427123724191](md-images/0427/image-20220427123724191.png)