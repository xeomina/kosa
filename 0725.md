# 0725

## EC2 인스턴스

* docker 인스턴스 생성
  * 사용자 데이터

```
#!/bin/bash
timedatectl set-timezone Asia/Seoul
cd /tmp
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
./aws/install
amazon-linux-extras install docker -y
systemctl enable --now docker
curl https://raw.githubusercontent.com/docker/docker-ce/master/components/cli/contrib/completion/bash/docker -o /etc/bash_completion.d/docker.sh
usermod -a -G docker ec2-user
docker run -d -p 80:80 --name test-site xeomina/web-site:v2.0
```

## Route 53

* 레코드 생성
  * `docker.xeomina.shop` 
  * `docker` 인스턴스의  public IP : 3.39.236.71

* `docker.xeomina.shop` 접속

![image-20220725100432657](md-images/0725/image-20220725100432657.png)



## ECR

* 리포지토리 생성
  * 퍼블릭
  * 이름 : `web-site`
* `aws configure` 후 클라이언트 인증

```
$ aws configure
$ aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/l1b8t9f0
```

* tag 지정해 push

```
$ aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/l1b8t9f0
$ docker images
$ docker tag xeomina/web-site:v2.0 public.ecr.aws/l1b8t9f0/web-site:latest
$ docker images
$ docker push public.ecr.aws/l1b8t9f0/web-site:latest
```

![image-20220725094335401](md-images/0725/image-20220725094335401.png)

![image-20220725094419048](md-images/0725/image-20220725094419048.png)

* `docker.xeomina.shop` 접속

![image-20220725100432657](md-images/0725/image-20220725100432657.png)



## EKS

> IAM 사용자

* 클러스터 생성

![image-20220725095015063](md-images/0725/image-20220725095015063.png)

![image-20220725095144417](md-images/0725/image-20220725095144417.png)

![image-20220725095208526](md-images/0725/image-20220725095208526.png)

* 노드 그룹 추가

![image-20220725100548004](md-images/0725/image-20220725100548004.png)

![image-20220725101035243](md-images/0725/image-20220725101035243.png)

![image-20220725101045555](md-images/0725/image-20220725101045555.png)

![image-20220725101442299](md-images/0725/image-20220725101442299.png)



## EKS CLI

* login

```
$ aws eks --region ap-northeast-2 update-kubeconfig --name EKS-CLUSTER
```

* kubectl 설치

```
$ curl -o kubectl https://s3.us-west-2.amazonaws.com/amazon-eks/1.22.6/2022-03-09/bin/linux/amd64/kubectl
$ kubectl get svc
$ kubectl get no
$ ls
```

![image-20220725110831551](md-images/0725/image-20220725110831551.png)

*  바이너리에 실행 권한 적용 및 경로 설정

```
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin
```

* kubectl 자동 완성
  * https://kubernetes.io/ko/docs/reference/kubectl/cheatsheet/

```
$ source <(kubectl completion bash)
$ echo "source <(kubectl completion bash)" >> ~/.bashrc
```

![image-20220725102820138](md-images/0725/image-20220725102820138.png)

* kubectl alias 설정

```
$ vi .bash_profile
alias k=kubectl
complete -F __start_kubectl k
```

![image-20220725102942697](md-images/0725/image-20220725102942697.png)

* exit 후 확인

```
$ k version
```

![image-20220725111024806](md-images/0725/image-20220725111024806.png)



**Cf) metallb**

* 퍼블릭 클라우드에서는 사용 불가... 온프레미스에서 사용!
* 퍼블릭 클라우드는 자체적 로드밸런서 보유... 굳이 metallb 기능 활성화할 필요 x